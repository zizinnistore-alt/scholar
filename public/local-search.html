<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCAL DB SEARCH // NEXUS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/global.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* [Previous styles remain, adding new ones below] */
        [data-theme="light"] {
            --bg-body: #f8fafc; --bg-card: #ffffff; --border: #cbd5e1; 
            --text-main: #0f172a; --text-muted: #64748b; --accent: #2563eb;
            --font-main: 'Inter', sans-serif; --font-header: 'Rajdhani', sans-serif;
        }

        body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Layout Grid */
        .scanner-layout {
            display: grid; grid-template-columns: 350px 1fr; gap: 30px; margin-top: 20px; align-items: start;
        }
        @media (max-width: 1100px) { .scanner-layout { grid-template-columns: 1fr; } }

        /* Left Panel */
        .panel {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            position: sticky; top: 90px; z-index: 10;
        }

        .panel-title { font-family: var(--font-header); font-size: 1.4rem; margin: 0 0 20px 0; display: flex; align-items: center; justify-content: space-between; }
        
        /* Inputs & Multi-select */
        .form-group { margin-bottom: 20px; position: relative; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        input, select { width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); padding: 12px 15px; border-radius: 8px; font-family: var(--font-main); box-sizing: border-box; outline:none; transition:0.3s;}
        
        /* Multi-select Tag Container */
        .tag-container {
            display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 5px;
        }
        .filter-tag {
            background: rgba(37, 99, 235, 0.1); color: var(--accent); 
            border: 1px solid rgba(37, 99, 235, 0.2); padding: 4px 8px; 
            border-radius: 4px; font-size: 0.75rem; font-weight: 600;
            display: flex; align-items: center; gap: 5px;
        }
        .filter-tag i { cursor: pointer; }
        .filter-tag i:hover { color: var(--danger); }

        /* Results List */
        .results-scroll { max-height: 500px; overflow-y: auto; padding-right: 5px; margin-top: 20px;}
        .results-scroll::-webkit-scrollbar { width: 6px; }
        .results-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        
        .author-card-mini {
            background: var(--bg-body); border: 1px solid var(--border); padding: 15px;
            border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s;
            border-left: 4px solid transparent; position: relative;
        }
        .author-card-mini:hover { border-color: var(--accent); border-left-color: var(--accent); transform: translateX(5px); }
        .ac-name { font-weight: 700; color: var(--text-main); font-size: 1rem; margin-bottom: 5px; }
        .ac-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px;}
        .field-badge { background: rgba(168, 85, 247, 0.1); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.2); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-top:5px;}

        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .dash-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
        }
        .dash-card.full-width { grid-column: span 3; }
        .dash-card.two-thirds { grid-column: span 2; }
        .stat-number { font-size: 2.5rem; font-weight: 800; font-family: var(--font-header); color: var(--accent); line-height: 1; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        .chart-container { position: relative; height: 250px; width: 100%; display: flex; align-items: center; justify-content: center; }

        /* Paper Styles */
        .paper-filters { display: flex; gap: 10px; margin-bottom: 15px; }
        .paper-row { 
            display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid var(--border); 
            background: var(--bg-body); border-radius: 8px; margin-bottom: 10px; 
            align-items: flex-start; transition: 0.2s;
        }
        .paper-row:hover { background: rgba(37, 99, 235, 0.05); }
        .paper-year { font-family: var(--font-header); font-size: 1.2rem; color: var(--accent); font-weight: bold; min-width: 50px; }
        .paper-content { flex: 1; }
        .paper-title { font-weight: 600; font-size: 1rem; color: var(--text-main); text-decoration: none; margin-bottom: 5px; display: block;}
        .paper-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 15px; align-items: center; margin-top: 5px;}
        .meta-badge { display: inline-flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border); }
        
        .pdf-btn { color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; text-decoration: none; font-weight: bold;}
        .pdf-btn:hover { background: #ef4444; color: white; }

        /* Personal Dash */
        .personal-dash-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .personal-dash-grid { grid-template-columns: 1fr; } }
        
        .co-author-pill {
            background: var(--bg-body); border: 1px solid var(--border); padding: 8px 12px;
            border-radius: 20px; text-decoration: none; color: var(--text-main); font-size: 0.85rem;
            display: flex; align-items: center; gap: 8px; transition: 0.2s; cursor: pointer;
        }
        .co-author-pill:hover { border-color: var(--accent); background: rgba(37, 99, 235, 0.05); }
        .co-author-pill.internal { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }

    /* NEW STYLES FOR TABS */
    .network-tabs {
        display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border);
    }
    .net-tab {
        background: none; border: none; padding: 10px 15px; cursor: pointer;
        color: var(--text-muted); font-weight: 600; font-family: var(--font-header);
        font-size: 1rem; border-bottom: 3px solid transparent; transition: 0.3s;
    }
    .net-tab:hover { color: var(--text-main); }
    .net-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    
    .network-list { display: none; }
    .network-list.active { display: flex; flex-wrap: wrap; gap: 10px; animation: fadeIn 0.3s ease; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

    <div id="app-header"></div>

    <div class="container">
        <!-- Dashboard Toggle -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="font-family: var(--font-header); margin: 0; font-size: 2rem;">RESEARCH DATABASE</h1>
            <div class="view-toggle" style="display: flex; gap: 10px;">
                <button class="vt-btn active" onclick="switchMode('list')" id="btn-list-mode"><i class="fas fa-list"></i> SEARCH</button>
                <button class="vt-btn" onclick="switchMode('dashboard')" id="btn-dash-mode"><i class="fas fa-chart-pie"></i> GLOBAL DASHBOARD</button>
            </div>
        </div>

        <div class="scanner-layout">
            
            <!-- SIDEBAR: FILTERS -->
            <div class="panel">
                <div class="panel-title">
                    <span><i class="fas fa-filter" style="color:var(--success)"></i> FILTERS</span>
                    <button onclick="resetFilters()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:0.8rem;">RESET</button>
                </div>
                
                <!-- Admin Upload -->
                <div id="admin-upload-box" style="display:none; background: rgba(16, 185, 129, 0.05); border: 1px dashed var(--success); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin:0 0 10px 0; color:var(--success); font-size:0.9rem;"><i class="fas fa-upload"></i> Update DB</h4>
                    <input type="text" id="csv-topic" placeholder="Main Topic Name" style="padding:8px; font-size:0.8rem; margin-bottom:5px;">
                    <input type="file" id="csv-file" accept=".xlsx, .xls, .csv" style="padding: 5px; font-size: 0.8rem;">
                    <button onclick="uploadDatabase()" style="background:var(--success); color:#fff; width:100%; border:none; padding:8px; border-radius:6px; margin-top:5px; cursor:pointer;">UPLOAD CSV</button>
                </div>

                <!-- Multi-Select Filters -->
                <div class="form-group">
                    <label>MAIN TOPICS (Multi)</label>
                    <div id="tags-maintopic" class="tag-container"></div>
                    <select id="select-maintopic" onchange="addTag('maintopic', this.value)">
                        <option value="">+ Add Topic</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>WORK DOMAINS (Multi)</label>
                    <div id="tags-subtopic" class="tag-container"></div>
                    <input type="text" id="input-subtopic" list="suggestions-subtopic" placeholder="+ Add Domain..." onchange="addTag('subtopic', this.value)">
                    <datalist id="suggestions-subtopic"></datalist>
                </div>

                <div class="form-group">
                    <label>UNIVERSITIES (Multi)</label>
                    <div id="tags-university" class="tag-container"></div>
                    <input type="text" id="input-university" list="suggestions-university" placeholder="+ Add University..." onchange="addTag('university', this.value)">
                    <datalist id="suggestions-university"></datalist>
                </div>

                <div class="form-group">
                    <label>RESEARCHER NAME</label>
                    <input type="text" id="filter-researcher" placeholder="Name search..." oninput="debounceFilter()">
                </div>

                <div style="font-size: 0.8rem; color: var(--text-muted); text-align: right; margin-top: -10px; margin-bottom: 20px;">
                    <span id="result-count">0</span> matches found
                </div>

                <div class="results-scroll" id="results-list"></div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-view">
                
                <!-- VIEW 1: Researcher Details -->
                <div id="view-details" style="display:block;">
                    <div id="detail-placeholder" style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); text-align: center; padding: 50px 20px; border: 2px dashed var(--border); border-radius: 16px;">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h2 style="font-family: var(--font-header); color: var(--text-main);">SELECT A RESEARCHER</h2>
                        <p>Click on a name from the list to view full profile, analytics, and papers.</p>
                    </div>
                    
                    <div id="detail-content" style="display:none;">
                        <!-- Content Injected via JS -->
                    </div>
                </div>

                <!-- VIEW 2: Global Dashboard -->
                <div id="view-dashboard" style="display:none;">
                    <div class="dashboard-grid">
                        <div class="dash-card">
                            <div class="stat-number" id="dash-total">0</div>
                            <div class="stat-label">Total Researchers</div>
                        </div>
                        <div class="dash-card">
                            <div class="stat-number" id="dash-top-topic" style="font-size: 1.5rem;">-</div>
                            <div class="stat-label">Top Research Field</div>
                        </div>
                        <div class="dash-card">
                            <div class="stat-number" id="dash-top-uni" style="font-size: 1.5rem;">-</div>
                            <div class="stat-label">Top University</div>
                        </div>

                        <div class="dash-card two-thirds">
                            <h3 style="font-family: var(--font-header);">University Distribution</h3>
                            <div class="chart-container"><canvas id="chart-uni"></canvas></div>
                        </div>
                        <div class="dash-card">
                            <h3 style="font-family: var(--font-header);">Topics</h3>
                            <div class="chart-container"><canvas id="chart-topic"></canvas></div>
                        </div>
                        <div class="dash-card full-width">
                            <h3 style="font-family: var(--font-header);">Work Domain Frequency</h3>
                            <div class="chart-container" style="height: 300px;"><canvas id="chart-subtopic"></canvas></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="app-footer"></div>
    <script src="/js/layout.js"></script>

<script>
    // --- STATE MANAGEMENT ---
    let allData = []; 
    let filteredData = [];
    let selectedFilters = { maintopic: [], subtopic: [], university: [] };
    let chartInstances = {};
    let currentAuthorPapers = [];
    
    // Create a map for fast lookup of internal researchers
    let localResearcherMap = new Map();

    const IGNORED_LOCATIONS = ["Egypt", "Saudi Arabia", "USA", "UK", "Canada", "China", "France", "Cairo", "Giza"];

    window.onload = () => {
        const user = JSON.parse(localStorage.getItem('nexus_user'));
        if(user && user.role === 'admin') document.getElementById('admin-upload-box').style.display = 'block';
        
        fetchMainTopics();
        initialLoad();
    };

    // --- DATA LOADING & CLEANING ---
    async function initialLoad() {
        try {
            const res = await fetch(`/api/local-researchers/filter`); 
            allData = await res.json();
            
            // Build Map for Internal Linking
            localResearcherMap.clear();
            allData.forEach(r => {
                if(r.scholar_id) localResearcherMap.set(r.scholar_id, r.id);
                // Also map by name as fallback? Maybe risky. Sticking to ID for now.
            });

            populateSuggestions(allData);
            runFilter(); 
        } catch (e) { console.error("Init Error", e); }
    }

    async function fetchMainTopics() {
        try {
            const res = await fetch('/api/local-researchers/main-topics');
            const topics = await res.json();
            const select = document.getElementById('select-maintopic');
            select.innerHTML = '<option value="">+ Add Topic</option>';
            topics.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.textContent = t;
                select.appendChild(opt);
            });
        } catch (e) { console.error('Failed to load topics', e); }
    }

    // --- MULTI-SELECT LOGIC ---
    function addTag(type, value) {
        if (!value) return;
        if (selectedFilters[type].includes(value)) return;
        
        selectedFilters[type].push(value);
        renderTags(type);
        
        // Reset inputs
        if(type !== 'maintopic') document.getElementById(`input-${type}`).value = '';
        else document.getElementById(`select-maintopic`).value = '';
        
        runFilter();
    }

    function removeTag(type, value) {
        selectedFilters[type] = selectedFilters[type].filter(v => v !== value);
        renderTags(type);
        runFilter();
    }

    function renderTags(type) {
        const container = document.getElementById(`tags-${type}`);
        container.innerHTML = selectedFilters[type].map(val => `
            <div class="filter-tag">
                ${val} <i class="fas fa-times" onclick="removeTag('${type}', '${val}')"></i>
            </div>
        `).join('');
    }

    function populateSuggestions(data) {
        const unis = new Set();
        const subs = new Set();

        data.forEach(item => {
            if (item.affiliation) {
                const clean = cleanAffiliation(item.affiliation);
                if(clean.length > 3) unis.add(clean);
            }
            if (item.subtopics) {
                item.subtopics.split(/[\/,]/).forEach(s => {
                    let cleanS = s.trim();
                    if(cleanS.length > 2 && !IGNORED_LOCATIONS.includes(cleanS)) subs.add(cleanS);
                });
            }
        });

        document.getElementById('suggestions-university').innerHTML = Array.from(unis).sort().map(u => `<option value="${u}">`).join('');
        document.getElementById('suggestions-subtopic').innerHTML = Array.from(subs).sort().map(s => `<option value="${s}">`).join('');
    }

    // --- FILTERING ---
    let debounceTimer;
    function debounceFilter() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(runFilter, 300);
    }

    async function runFilter() {
        const researcher = document.getElementById('filter-researcher').value;
        const list = document.getElementById('results-list');
        list.innerHTML = '<div style="padding:10px; text-align:center;"><i class="fas fa-spinner fa-spin"></i></div>';

        const params = new URLSearchParams();
        if (selectedFilters.maintopic.length) params.append('main_topic', selectedFilters.maintopic.join(','));
        if (selectedFilters.subtopic.length) params.append('subtopic', selectedFilters.subtopic.join(','));
        if (selectedFilters.university.length) params.append('university', selectedFilters.university.join(','));
        if (researcher) params.append('researcher', researcher);

        try {
            const res = await fetch(`/api/local-researchers/filter?${params.toString()}`);
            filteredData = await res.json();
            
            document.getElementById('result-count').innerText = filteredData.length;
            renderList(filteredData);

            if (document.getElementById('view-dashboard').style.display === 'block') {
                updateGlobalDashboard();
            }
        } catch (e) { list.innerHTML = 'Error.'; }
    }

    function renderList(data) {
        const list = document.getElementById('results-list');
        if(data.length === 0) { list.innerHTML = '<div style="padding:20px; text-align:center;">No matches.</div>'; return; }
        
        list.innerHTML = data.map(r => {
            const cleanUni = cleanAffiliation(r.affiliation);
            return `
            <div class="author-card-mini" onclick="analyzeLocal(${r.id})">
                <div class="ac-name">${r.name}</div>
                <div class="ac-meta"><i class="fas fa-university" style="font-size:0.7rem;"></i> ${cleanUni}</div>
                ${r.main_topic ? `<span class="field-badge">${r.main_topic}</span>` : ''}
            </div>
        `}).join('');
    }

    function cleanAffiliation(raw) {
        if (!raw) return "Unknown";
        let str = raw.replace(/Professor|Dr\.|Assoc\.|Dept\.|Faculty of/gi, '');
        if (str.includes(' at ')) str = str.split(' at ')[1];
        if (str.includes(',')) str = str.split(',')[0]; 
        IGNORED_LOCATIONS.forEach(l => { str = str.replace(l, ''); });
        return str.trim();
    }

    // --- VIEW SWITCHING ---
    function switchMode(mode) {
        document.querySelectorAll('.vt-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${mode === 'list' ? 'list' : 'dash'}-mode`).classList.add('active');
        
        document.getElementById('view-details').style.display = mode === 'list' ? 'block' : 'none';
        document.getElementById('view-dashboard').style.display = mode === 'dashboard' ? 'block' : 'none';
        
        if (mode === 'dashboard') updateGlobalDashboard();
    }

    // --- ANALYZE PROFILE ---
    async function analyzeLocal(id) {
        // Switch to detail view if in dashboard mode
        if(document.getElementById('view-dashboard').style.display === 'block') switchMode('list');

        const contentDiv = document.getElementById('detail-content');
        const placeholder = document.getElementById('detail-placeholder');
        
        placeholder.style.display = 'none';
        contentDiv.style.display = 'block';
        contentDiv.innerHTML = `
            <div style="text-align:center; margin-top:50px;">
                <i class="fas fa-circle-notch fa-spin" style="font-size:3rem; color:var(--success);"></i>
                <br><br>Analyzing Profile...
            </div>
        `;

        try {
            const res = await fetch('/api/local-researchers/analyze', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            const data = await res.json();
            renderProfile(data);
        } catch (e) {
            contentDiv.innerHTML = `<div style="color:var(--danger)">Failed to load data.</div>`;
        }
    }

    function renderProfile(data) {
        const { local, author, collaborators } = data;
        const cleanUni = cleanAffiliation(local.affiliation);
        currentAuthorPapers = author ? author.papers : [];

        const gsLink = local.scholar_id && !local.scholar_id.match(/^\d+$/) 
            ? `https://scholar.google.com/citations?user=${local.scholar_id}` 
            : null;

        // Render Internal/External Co-authors
        const collabHtml = (collaborators && collaborators.length) ? collaborators.map(c => {
            const internalId = localResearcherMap.get(c.id);
            const clickAction = internalId ? `onclick="analyzeLocal(${internalId})"` : `onclick="window.open('https://www.semanticscholar.org/author/${c.id}', '_blank')"`;
            const classMod = internalId ? 'internal' : '';
            const icon = internalId ? 'fa-user-check' : 'fa-external-link-alt';
            return `
                <div class="co-author-pill ${classMod}" ${clickAction}>
                    <i class="fas ${icon}" style="font-size:0.7rem; color:var(--accent)"></i>
                    ${c.name}
                    <span style="opacity:0.6; font-size:0.7rem;">(${c.count})</span>
                </div>
            `;
        }).join('') : '<span style="color:var(--text-muted)">No data.</span>';

        // Profile HTML
        const html = `
            <div style="padding-bottom:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                <div>
                    <h1 style="margin:0; font-family:var(--font-header); font-size:2rem;">${local.name}</h1>
                    <div style="color:var(--text-muted); margin-top:5px;">
                        <i class="fas fa-university"></i> ${cleanUni} 
                        ${local.main_topic ? ` &bull; <span style="color:var(--accent)">${local.main_topic}</span>` : ''}
                    </div>
                    <div style="margin-top:8px; font-size:0.9rem; color:var(--text-muted);">
                        <i class="fas fa-tag"></i> <b>Interests:</b> ${local.subtopics ? local.subtopics.replace(/,/g, ', ') : 'General'}
                    </div>
                </div>
                <div>
                    ${gsLink ? `<a href="${gsLink}" target="_blank" class="btn-action" style="background:#ea4335"><i class="fas fa-graduation-cap"></i> Google Scholar</a>` : ''}
                    ${author && author.url ? `<a href="${author.url}" target="_blank" class="btn-action"><i class="fas fa-book-reader"></i> Semantic Scholar</a>` : ''}
                </div>
            </div>

            <!-- PERSONAL DASHBOARD -->
            <div class="personal-dash-grid" style="margin-top:20px;">
                <div class="dash-card">
                    <h4 class="section-title" style="border:none; margin:0;"><i class="fas fa-chart-pie"></i> Fields of Study</h4>
                    <div class="chart-container" style="height:200px;"><canvas id="chart-personal-fields"></canvas></div>
                </div>
                <div class="dash-card">
                    <div style="text-align:center; padding:10px;">
                        <div class="stat-number">${author ? author.hIndex : '?'}</div>
                        <div class="stat-label">H-INDEX</div>
                    </div>
                    <div style="text-align:center; padding:10px; border-top:1px solid var(--border);">
                        <div class="stat-number" style="color:#10b981; font-size:2rem;">${author ? author.citationCount : '?'}</div>
                        <div class="stat-label">CITATIONS</div>
                    </div>
                    <div style="text-align:center; padding:10px; border-top:1px solid var(--border);">
                        <div class="stat-number" style="color:#a855f7; font-size:2rem;">${author ? author.paperCount : '?'}</div>
                        <div class="stat-label">PAPERS</div>
                    </div>
                </div>
            </div>

            <!-- CO-AUTHORS -->
            <div class="section-title"><i class="fas fa-users"></i> Top Co-Authors</div>
            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:30px;">
                ${collabHtml}
            </div>

            <!-- PAPERS LIST WITH FILTERS -->
            <div class="section-title"><i class="fas fa-scroll"></i> Publications</div>
            <div class="paper-filters">
                <input type="text" id="paper-search" placeholder="Search title..." oninput="filterPapers()">
                <input type="number" id="paper-year" placeholder="Year" style="width:100px;" oninput="filterPapers()">
            </div>
            
            <div id="paper-list-container" style="max-height:500px; overflow-y:auto;">
                <!-- Papers Injected Here -->
            </div>
        `;

        document.getElementById('detail-content').innerHTML = html;
        
        // Init Personal Chart
        renderPersonalChart(author);
        // Init Papers
        filterPapers();
    }

    
    function renderPersonalChart(author) {
        if(!author || !author.papers) return;
        
        // Count fields
        const counts = {};
        author.papers.forEach(p => {
            if(p.fieldsOfStudy) p.fieldsOfStudy.forEach(f => counts[f] = (counts[f]||0)+1);
        });
        
        const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0, 6);
        const ctx = document.getElementById('chart-personal-fields');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: sorted.map(x => x[0]),
                datasets: [{
                    data: sorted.map(x => x[1]),
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#a855f7', '#6366f1'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } }
        });
    }

    function filterPapers() {
        if(!currentAuthorPapers) return;
        
        const q = document.getElementById('paper-search').value.toLowerCase();
        const y = document.getElementById('paper-year').value;
        const container = document.getElementById('paper-list-container');

        const filtered = currentAuthorPapers.filter(p => {
            const matchQ = !q || (p.title && p.title.toLowerCase().includes(q));
            const matchY = !y || (p.year && p.year == y);
            return matchQ && matchY;
        });

        if(filtered.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted); padding:20px;">No papers match criteria.</div>';
            return;
        }

        container.innerHTML = filtered.map(p => {
            const hasPdf = p.openAccessPdf && p.openAccessPdf.url;
            return `
            <div class="paper-row">
                <div class="paper-year">${p.year || '-'}</div>
                <div class="paper-content">
                    <a href="${p.url}" target="_blank" class="paper-title">${p.title}</a>
                    <div class="paper-meta">
                        <span class="meta-badge"><i class="fas fa-book"></i> ${p.venue || 'Journal'}</span>
                        <span class="meta-badge" style="color:var(--success)"><i class="fas fa-quote-right"></i> ${p.citationCount || 0}</span>
                        ${hasPdf ? `<a href="${p.openAccessPdf.url}" target="_blank" class="pdf-btn"><i class="fas fa-file-pdf"></i> PDF</a>` : ''}
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // --- GLOBAL DASHBOARD CHARTS ---
    function updateGlobalDashboard() {
        const uniCounts = {}, topicCounts = {}, subCounts = {};
        
        filteredData.forEach(d => {
            const u = cleanAffiliation(d.affiliation); if(u.length>3) uniCounts[u] = (uniCounts[u]||0)+1;
            const t = d.main_topic || "Uncategorized"; topicCounts[t] = (topicCounts[t]||0)+1;
            if(d.subtopics) d.subtopics.split(/[\/,]/).forEach(s => {
                let cs = s.trim(); if(cs.length>2 && !IGNORED_LOCATIONS.includes(cs)) subCounts[cs] = (subCounts[cs]||0)+1;
            });
        });

        const sortUni = Object.entries(uniCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const sortTopic = Object.entries(topicCounts).sort((a,b)=>b[1]-a[1]);
        const sortSub = Object.entries(subCounts).sort((a,b)=>b[1]-a[1]).slice(0,20);

        document.getElementById('dash-total').innerText = filteredData.length;
        document.getElementById('dash-top-topic').innerText = sortTopic[0]?.[0] || '-';
        document.getElementById('dash-top-uni').innerText = sortUni[0]?.[0] || '-';

        renderChart('chart-uni', 'bar', sortUni, 'Researchers');
        renderChart('chart-topic', 'doughnut', sortTopic, 'Topics');
        renderChart('chart-subtopic', 'bar', sortSub, 'Domains');
    }

    function renderChart(id, type, data, label) {
        const ctx = document.getElementById(id).getContext('2d');
        if(chartInstances[id]) chartInstances[id].destroy();
        
        chartInstances[id] = new Chart(ctx, {
            type: type,
            data: {
                labels: data.map(d=>d[0]),
                datasets: [{ 
                    label: label, 
                    data: data.map(d=>d[1]),
                    backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#a855f7'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: type==='doughnut', labels:{color:'#94a3b8'} } },
                scales: type==='bar' ? { 
                    y: { beginAtZero:true, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }, 
                    x: { display:false } 
                } : {}
            }
        });
    }

    async function uploadDatabase() {
        const fileInput = document.getElementById('csv-file');
        if(fileInput.files.length === 0) return Swal.fire('Error', 'Select file', 'error');
        
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append('main_topic', document.getElementById('csv-topic').value);
        formData.append('clear_db', 'false');

        try {
            const res = await fetch('/api/admin/upload-researchers', { method: 'POST', body: formData });
            const data = await res.json();
            if(res.ok) { Swal.fire('Success', data.message, 'success'); fetchMainTopics(); initialLoad(); }
            else Swal.fire('Error', data.error, 'error');
        } catch(e) { Swal.fire('Error', 'Failed', 'error'); }
    }
</script>
</body>
</html>